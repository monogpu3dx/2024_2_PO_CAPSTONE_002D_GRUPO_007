<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Carrito de compras - Reciclothes">
    <title>Carrito - Reciclothes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="media/ReciClothes_sinf.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.css" />
</head>
<body style="background-image: url('https://treenewal.com/wp-content/uploads/2020/11/environmental_factors_affecting_trees.png'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed; 
            background-repeat: no-repeat;">
    <header class="bg-success py-2">
        <div class="leaves-container">
            <div class="leaf"></div>
            <div class="leaf"></div>
            <div class="leaf"></div>
            <div class="leaf"></div>
            <div class="leaf"></div>
            <div class="leaf"></div>
            <div class="leaf"></div>
            <div class="leaf"></div>
            <div class="leaf"></div>
            <div class="leaf"></div>
        </div>
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-auto">
                    <a href="index.html" class="text-white text-decoration-none d-flex align-items-center">
                        <img src="media/ReciClothes_sinf.png" width="60" height="60" class="d-inline-block align-top me-2" alt="Reciclothes logo">
                        <span class="fs-5 fw-bold custom-font">Reciclothes</span>
                    </a>
                </div>
                <div class="col">
                    <div class="dropdown">
                        <button class="btn btn-success dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                            Categorías
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" href="productos.html?categoria=mujeres">Mujeres</a></li>
                            <li><a class="dropdown-item" href="productos.html?categoria=ninos">Niños</a></li>
                            <li><a class="dropdown-item" href="productos.html?categoria=hombres">Hombres</a></li>
                            <li><a class="dropdown-item" href="productos.html?categoria=accesorios">Accesorios</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-auto ms-auto">
                    <a href="carrito.html" class="btn btn-success me-2">
                        <i class="bi bi-cart"></i>
                    </a>
                    <div class="dropdown d-inline-block">
                        <a href="login.html" class="btn btn-success dropdown-toggle" id="loginButton" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person"></i>
                            <span>Sesión: </span><span id="nombreUsuario"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main class="container mt-5">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body">
                        <h2 class="mb-4">Carrito de Compras</h2>
                        <div id="carritoVacio" class="alert alert-info" style="display: none;">
                            Tu carrito está vacío
                        </div>
                        <div id="carritoItems">
                            <!-- Los items del carrito se insertarán aquí -->
                        </div>
                        <div class="row mt-4" id="carritoResumen" style="display: none;">
                            <div class="col-md-6">
                                <h4>Total: $<span id="carritoTotal">0</span></h4>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-danger me-2" onclick="vaciarCarrito()">
                                    Vaciar Carrito
                                </button>
                                <button class="btn btn-success" onclick="mostrarFormularioPago()">
                                    Procesar Compra
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div class="modal fade" id="formularioPagoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Formulario de Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formularioPago">
                        <div class="mb-3">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" name="nombre" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dirección de Envío</label>
                            <input type="text" name="direccion" id="direccionInput" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Número de Casa/Depto</label>
                            <input type="text" name="numeroCasa" id="numeroCasa" class="form-control" required placeholder="Ej: 123 Depto 45">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Correo Electrónico</label>
                            <input type="email" name="email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" name="telefono" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Proceder al Pago</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <footer class="bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <p class="text-center mb-0">&copy; 2024 Reciclothes. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.umd.js"></script>
    <script>
        // Agregar al inicio del script
        function verificarSesion() {
            const token = localStorage.getItem('userToken');
            if (!token) {
                alert('Debes iniciar sesión para acceder al carrito');
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Función para cargar el carrito
        function cargarCarrito() {
            if (!verificarSesion()) return;
            
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const carritoItems = document.getElementById('carritoItems');
            const carritoVacio = document.getElementById('carritoVacio');
            const carritoResumen = document.getElementById('carritoResumen');
            const carritoTotal = document.getElementById('carritoTotal');

            if (carrito.length === 0) {
                carritoVacio.style.display = 'block';
                carritoResumen.style.display = 'none';
                carritoItems.innerHTML = '';
                return;
            }
            carritoVacio.style.display = 'none';
            carritoResumen.style.display = 'flex';
            let total = 0;
            carritoItems.innerHTML = carrito.map(item => {
                total += item.price * item.cantidad;
                return `
                    <div class="card mb-3">
                        <div class="row g-0">
                            <div class="col-md-2">
                                <img src="${item.imagen || 'media/polera.png'}" class="img-fluid rounded-start" alt="${item.name}">
                            </div>
                            <div class="col-md-8">
                                <div class="card-body">
                                    <h5 class="card-title">${item.name}</h5>
                                    <p class="card-text">Precio: $${item.price.toLocaleString('es-CL')}</p>
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="actualizarCantidad(${item.Id_Producto}, -1)">-</button>
                                        <span class="mx-2">Cantidad: ${item.cantidad}</span>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="actualizarCantidad(${item.Id_Producto}, 1)">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 d-flex align-items-center justify-content-center">
                                <button class="btn btn-danger" onclick="eliminarDelCarrito(${item.Id_Producto})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            carritoTotal.textContent = total.toLocaleString('es-CL');
        }

        // Función para actualizar cantidad
        function actualizarCantidad(Id_Producto, cambio) {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const itemIndex = carrito.findIndex(item => item.Id_Producto === Id_Producto);
            
            if (itemIndex !== -1) {
                carrito[itemIndex].cantidad += cambio;
                if (carrito[itemIndex].cantidad < 1) {
                    carrito.splice(itemIndex, 1);
                }
                localStorage.setItem('carrito', JSON.stringify(carrito));
                cargarCarrito();
            }
        }

        // Función para eliminar del carrito
        function eliminarDelCarrito(Id_Producto) {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const nuevoCarrito = carrito.filter(item => item.Id_Producto !== Id_Producto);
            localStorage.setItem('carrito', JSON.stringify(nuevoCarrito));
            cargarCarrito();
        }

        // Función para vaciar carrito
        function vaciarCarrito() {
            if (confirm('¿Estás seguro de que deseas vaciar el carrito?')) {
                localStorage.removeItem('carrito');
                cargarCarrito();
            }
        }

        // Función para mostrar el formulario de pago
        function mostrarFormularioPago() {
            const token = localStorage.getItem('userToken');
            if (!token) {
                alert('Debes iniciar sesión para realizar la compra');
                window.location.href = 'login.html';
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('formularioPagoModal'));
            modal.show();
            prellenarFormulario();
        }

        // Reemplazar la función inicializarAutocompletado
        function inicializarAutocompletado() {
            const input = document.getElementById('direccionInput');
            const provider = new GeoSearch.OpenStreetMapProvider({
                params: {
                    countrycodes: 'cl',
                    limit: 5
                }
            });

            let timeoutId;
            input.addEventListener('input', async function() {
                clearTimeout(timeoutId);
                const query = this.value;

                if (query.length < 3) {
                    let listaSugerencias = document.getElementById('sugerencias-direcciones');
                    if (listaSugerencias) listaSugerencias.remove();
                    return;
                }

                timeoutId = setTimeout(async () => {
                    try {
                        const results = await provider.search({ query: query + ', Chile' });
                        mostrarSugerencias(results, input);
                    } catch (error) {
                        console.error('Error al buscar direcciones:', error);
                    }
                }, 300);
            });
        }

        function mostrarSugerencias(results, input) {
            let listaSugerencias = document.getElementById('sugerencias-direcciones');
            if (listaSugerencias) {
                listaSugerencias.remove();
            }

            if (results.length === 0) return;

            listaSugerencias = document.createElement('ul');
            listaSugerencias.id = 'sugerencias-direcciones';
            listaSugerencias.className = 'list-group position-absolute w-100';

            results.forEach(result => {
                const item = document.createElement('li');
                item.className = 'list-group-item list-group-item-action';
                
                // Limpiar la dirección para mostrar solo lo necesario
                let direccionLimpia = result.label
                    .replace(/, Chile/g, '')  // Remover ", Chile"
                    .replace(/\d{5,}|CP \d+/g, '')  // Remover códigos postales
                    .replace(/,\s*,/g, ',')  // Limpiar comas dobles
                    .replace(/\s+/g, ' ')    // Limpiar espacios múltiples
                    .trim();                 // Limpiar espacios al inicio y final

                item.textContent = direccionLimpia;
                item.style.cursor = 'pointer';

                item.addEventListener('click', () => {
                    input.value = direccionLimpia;
                    listaSugerencias.remove();
                    // Enfocar automáticamente el campo de número de casa
                    document.getElementById('numeroCasa').focus();
                });

                listaSugerencias.appendChild(item);
            });

            input.parentNode.style.position = 'relative';
            input.parentNode.appendChild(listaSugerencias);
        }

        // Estilos básicos
        const styles = `
            #sugerencias-direcciones {
                border: 1px solid #ddd;
                background-color: white;
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
            }
            #sugerencias-direcciones li:hover {
                background-color: #f8f9fa;
            }
        `;

        const styleSheet = document.createElement("style");
        styleSheet.innerText = styles;
        document.head.appendChild(styleSheet);

        // Agregar después de la función verificarSesion()
        function mostrarUsuarioActual() {
            const token = localStorage.getItem('userToken');
            const nombreUsuario = localStorage.getItem('userName');
            const loginButton = document.getElementById('loginButton');
            const nombreUsuarioSpan = document.getElementById('nombreUsuario');

            if (token && nombreUsuario) {
                nombreUsuarioSpan.textContent = nombreUsuario;
                loginButton.href = '#';
                loginButton.onclick = cerrarSesion;
            } else {
                nombreUsuarioSpan.textContent = '';
                loginButton.href = 'login.html';
                loginButton.onclick = null;
            }
        }

        function cerrarSesion() {
            if (confirm('¿Deseas cerrar sesión?')) {
                localStorage.removeItem('userToken');
                localStorage.removeItem('userName');
                window.location.href = 'login.html';
            }
        }

        // Modificar el DOMContentLoaded para incluir mostrarUsuarioActual
        document.addEventListener('DOMContentLoaded', () => {
            mostrarUsuarioActual();
            if (verificarSesion()) {
                cargarCarrito();
                const formularioPago = document.getElementById('formularioPago');
                formularioPago.addEventListener('submit', procesarCompra);
                inicializarAutocompletado();
                
                // Limpiar formulario cuando se cierra el modal
                const modal = document.getElementById('formularioPagoModal');
                modal.addEventListener('hidden.bs.modal', () => {
                    formularioPago.reset();
                });
            }
        });

        // Función para actualizar el botón de login
        function actualizarBotonLogin() {
            const userData = localStorage.getItem('userData');
            const loginButton = document.getElementById('loginButton');
            
            if (userData) {
                const user = JSON.parse(userData);
                loginButton.innerHTML = `
                    <i class="bi bi-person"></i>
                    <span class="d-none d-md-inline">Sesión: ${user.name}</span>
                    <span class="d-md-none"><i class="bi bi-person-check"></i></span>
                `;
                loginButton.href = '#';
            } else {
                loginButton.innerHTML = `
                    <i class="bi bi-person"></i>
                    <span class="d-none d-md-inline">Iniciar Sesión</span>
                `;
                loginButton.href = 'login.html';
                loginButton.classList.remove('dropdown-toggle');
                loginButton.removeAttribute('data-bs-toggle');
            }
        }

        // Función para cerrar sesión
        function cerrarSesion() {
            localStorage.removeItem('userToken');
            localStorage.removeItem('userData');
            localStorage.removeItem('adminToken');
            window.location.reload();
        }

        // Ejecutar cuando se carga la página
        window.addEventListener('load', actualizarBotonLogin);

        async function procesarCompra(event) {
            event.preventDefault();
            
            try {
                const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
                if (carrito.length === 0) {
                    throw new Error('El carrito está vacío');
                }

                const token = localStorage.getItem('userToken');
                const userData = JSON.parse(localStorage.getItem('userData'));
                
                if (!token || !userData) {
                    throw new Error('No hay sesión activa');
                }

                const formData = new FormData(event.target);
                
                // Validar campos requeridos
                const camposRequeridos = ['nombre', 'email', 'direccion', 'telefono', 'numeroCasa'];
                for (const campo of camposRequeridos) {
                    if (!formData.get(campo)) {
                        throw new Error(`El campo ${campo} es requerido`);
                    }
                }

                // Crear objeto con el formato de la tabla orden incluyendo el ID del cliente
                const datosOrden = {
                    Id_Cliente: userData.Id_Cliente,
                    cliente: formData.get('nombre').trim(),
                    email: formData.get('email').trim(),
                    telefono: formData.get('telefono').trim(),
                    direccion: formData.get('direccion').trim(),
                    numero_casa: formData.get('numeroCasa').trim(),
                    products: carrito.map(item => ({
                        id: item.Id_Producto,
                        name: item.name,
                        cantidad: item.cantidad
                    })),
                    order_date: new Date().toISOString(),
                    total_amount: carrito.reduce((sum, item) => sum + (item.price * item.cantidad), 0),
                    estado: 'pendiente'
                };
                console.log(datosOrden);

                const response = await fetch('https://reciclothes.onrender.com/api/ordenes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(datosOrden)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error al procesar la orden');
                }

                const resultado = await response.json();
                
                if (resultado.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('formularioPagoModal'));
                    modal.hide();
                    alert(`¡Compra procesada con éxito!\nTu número de orden es: ${resultado.Id_Orden}\nRecuerda subir el comprobante de pago en la sección "Mis Pedidos"`);
                    localStorage.removeItem('carrito');
                    window.location.href = 'index.html';
                } else {
                    throw new Error(resultado.message || 'Error al procesar la orden');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar la compra: ' + error.message);
            }
        }

        function prellenarFormulario() {
            const userData = JSON.parse(localStorage.getItem('userData'));
            if (userData) {
                const form = document.getElementById('formularioPago');
                form.querySelector('[name="nombre"]').value = userData.name || '';
                form.querySelector('[name="email"]').value = userData.email || '';
                form.querySelector('[name="telefono"]').value = userData.phone || '';
                form.querySelector('[name="direccion"]').value = userData.address || '';
                form.querySelector('[name="numeroCasa"]').value = userData.numero_casa || '';
            }
        }
    </script>
</body>
</html>
